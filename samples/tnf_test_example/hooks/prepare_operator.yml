---
- name: Define catalog path and version
  set_fact:
    catalog_path: "{{ dci_local_registry }}/telcoci/testnetworkfunction/{{ tnf_operator_to_install.operator_name }}-disconnected-catalog"
    catalog_version: "{{ tnf_operator_to_install.operator_version }}_{{ lookup('password', '/dev/null length=16 chars=ascii_lowercase,digits') }}"

- name: Create temporary directory for mirroring catalog
  tempfile:
    state: directory
    prefix: tnf_test_example_prerun_tmp_dir.
  register: tnf_test_example_prerun_tmp_dir

- name: Copy authentication config
  copy:
    src: "{{ partner_creds }}"
    dest: "{{ tnf_test_example_prerun_tmp_dir.path }}/config.json"

- name: "Create FBC catalog"
  include_role:
    name: fbc-catalog
    apply:
      environment:
        - DOCKER_CONFIG: "{{ tnf_test_example_prerun_tmp_dir.path }}"
  vars:
    fbc_index_image: "{{ catalog_path }}:{{ catalog_version }}"
    fbc_bundles:
      - "{{ tnf_operator_to_install.operator_bundle }}"
    fbc_opm_args: "--skip-tls-verify=false"

- name: Push catalog image into local registry
  shell: >
    podman push --authfile {{ pullsecret_tmp_file }}
    {{ catalog_path }}:{{ catalog_version }}

- name: Get catalog Digest
  shell:
    cmd: >
      skopeo inspect --authfile {{ pullsecret_tmp_file }}
      docker://{{ catalog_path }}:{{ catalog_version }} | jq -r '.Digest'
  register: catalog_sha
  retries: 5
  delay: 5
  until:
    - catalog_sha is not failed

- name: Mirror images and save manifests into a temporary directory
  shell: >
    {{ oc_tool_path }} adm catalog mirror
    --registry-config {{ pullsecret_tmp_file }}
    --max-components=3
    {{ catalog_path }}@{{ catalog_sha.stdout }}
    {{ dci_local_registry }}
    --to-manifests={{ tnf_test_example_prerun_tmp_dir.path }}/tmp_oc
  register: catalog_mirror
  retries: 2
  delay: 10
  until: catalog_mirror.stderr.find('error:') == -1

- name: Set image source file fact
  vars:
    is_manifest_files:
      - "{{ tnf_test_example_prerun_tmp_dir.path }}/tmp_oc/imageDigestMirrorSet.yaml"
      - "{{ tnf_test_example_prerun_tmp_dir.path }}/tmp_oc/imageContentSourcePolicy.yaml"
  set_fact:
    tnf_is_file: "{{ lookup('first_found', is_manifest_files) }}"

- name: "Remove local catalog image"
  shell: |
    podman rmi "{{ catalog_path }}:{{ catalog_version }}"

- name: Re-define catalog path + sha
  set_fact:
    catalog_path: "{{ catalog_path }}@{{ catalog_sha.stdout }}"

- name: Find ImageDigestMirrorSet in the cluster
  community.kubernetes.k8s_info:
    api_version: config.openshift.io/v1
    kind: ImageDigestMirrorSet
  register: idms_resources

- name: Set image source kind
  set_fact:
    image_source_kind: >
      {{ idms_resources.resources |
         length |
         ternary('ImageDigestMirrorSet', 'ImageContentSourcePolicy')
      }}

- name: Migrate ICSP to IDMS
  when:
    - image_source_kind == 'ImageDigestMirrorSet'
    - "'imageContentSourcePolicy.yaml' in tnf_is_file"
  block:
    - name: Transform ICSP to IDMS
      shell:
        cmd: >
          {{ oc_tool_path }} adm migrate icsp
          {{ tnf_is_file }}
          --dest-dir {{ tnf_test_example_prerun_tmp_dir.path }}
      register: migrate_result

    - name: Set new image source file
      set_fact:
        tnf_is_file: "{{ migrate_result.stdout_lines[0].split(' ')[-1] }}"

- name: Apply Image Source file
  community.kubernetes.k8s:
    definition: "{{ lookup('file', tnf_is_file) }}"

- name: Remove temporary directory
  file:
    path: "{{ tnf_test_example_prerun_tmp_dir.path }}"
    state: absent

- name: Wait for MCP status
  include_role:
    name: check-resource
  vars:
    resource_to_check: "MachineConfigPool"
    check_wait_retries: 60
    check_wait_delay: 60
    check_reason: "TNF test example"
...
