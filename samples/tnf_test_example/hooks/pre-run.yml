---
- name: "Install required rpm packages"
  package:
    name: "{{ item }}"
    state: present
  loop:
    - curl
    - python3-openshift
    - python3-pyyaml
  become: true

# If we are in connected environments, define default values for the Helm chart and operator to
# be installed in this example.
- name: Declare tnf variables for connected environments
  include_tasks: declare_tnf_variables_connected.yml
  when: not dci_disconnected | default(false) | bool

# Validate that the parameters related to Helm chart and operator to be installed are defined,
# to be sure they have also been defined for disconnected environments.
- name: Validate that tnf variables are defined
  assert:
    that: "{{ item }} is defined"
    fail_msg: "The variable {{ item }} is required"
  with_items:
      - tnf_operator_to_install
      - tnf_operator_to_install.operator_name
      - tnf_operator_to_install.operator_version
      - tnf_operator_to_install.operator_bundle
      - tnf_helm_chart_to_install
      - tnf_helm_chart_to_install.chart_url
      - tnf_helm_chart_to_install.image_repository

- name: Mirror images in disconnected environments
  include_role:
    name: mirror_images
  vars:
    images:
      - quay.io/testnetworkfunction/cnf-test-partner:latest
      - "{{ tnf_helm_chart_to_install.image_repository }}"
    local_registry: "{{ provisionhost_registry }}"
    authfile: "{{ pullsecret_tmp_file }}"
  when:
    - dci_disconnected | default(false) | bool
    - provisionhost_registry|length
    - pullsecret_tmp_file|length

# Following the same scope than in preflight for preparing the operator in disconnected environments
- name: Preparing the operator in disconnected environments
  include_tasks: prepare_operator.yml
  when:
    - dci_disconnected | default(false) | bool
    - provisionhost_registry|length
    - pullsecret_tmp_file|length

...
