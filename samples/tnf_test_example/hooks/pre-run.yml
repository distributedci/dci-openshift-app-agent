---

# First task to do: if the variables are not correctly defined, do not continue.
- name: Declare tnf variables
  include_tasks: declare_tnf_variables.yml

# Make sure that we don't have any remaining resources before starting tests, just
# in case they were not deleted properly in previous executions in the same cluster.
- name: Run cleaning tasks
  include_tasks: cleaning_tasks.yml

- name: "Install required rpm packages"
  package:
    name: "{{ item }}"
    state: present
  loop:
    - curl
    - python3-openshift
    - python3-pyyaml
  become: true

- name: Mirror images in disconnected environments
  include_role:
    name: mirror_images
  vars:
    images:
      - quay.io/testnetworkfunction/cnf-test-partner:latest
    authfile: "{{ pullsecret_tmp_file }}"
  when:
    - dci_disconnected | default(false) | bool
    - dci_local_registry | length
    - pullsecret_tmp_file|length

# Following the same scope than in preflight for preparing the operator in disconnected environments
- name: Preparing the operator in disconnected environments
  include_tasks: prepare_operator.yml
  when:
    - tnf_operator_to_install is defined
    - dci_disconnected | default(false) | bool
    - dci_local_registry | length
    - pullsecret_tmp_file|length

# Doing it separately in case no component is provided.
- name: Preparing the Helm chart in disconnected environments
  include_tasks: prepare_helm_chart.yml
  when:
    - tnf_helm_chart_to_install is defined
    - dci_disconnected | default(false) | bool
    - dci_local_registry | length
    - pullsecret_tmp_file|length

# If enabled, we will use NFS external storage to create the volumes for the pods under test.
- name: Configure NFS external storage if enabled
  block:
    - name: "Mirroring the NFS external storage provisioner image"
      include_role:
        name: mirror_images
      vars:
        images: ['registry.k8s.io/sig-storage/nfs-subdir-external-provisioner:v4.0.2']
        authfile: "{{ pullsecret_tmp_file }}"
      when:
        - dci_disconnected | default(false) | bool
        - dci_local_registry | length
        - pullsecret_tmp_file|length

    - name: "Deploy NFS external storage"
      include_role:
        name: nfs-external-storage
      vars:
        nes_nfs_server: "{{ nfs_server }}"
        nes_nfs_path: "{{ nfs_path }}"
        nes_path_pattern: "{{ job_id is defined |
                            ternary( job_id+'_${.PVC.name}', omit) }}"
        nes_provisioner_image: "{{ dci_disconnected | default(false) | bool |
                                ternary( dci_local_registry+'/sig-storage/nfs-subdir-external-provisioner:v4.0.2',
                                'registry.k8s.io/sig-storage/nfs-subdir-external-provisioner:v4.0.2' ) }}"
  when: enable_nfs_storage | default(false) | bool

...
