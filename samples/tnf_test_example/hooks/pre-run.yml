---
- name: "Install required rpm packages"
  package:
    name: "{{ item }}"
    state: present
  loop:
    - curl
    - python3-openshift
    - python3-pyyaml
  become: true

# Following the same scope than in preflight for preparing the operator in disconnected environments
- name: Copy operator bundle image
  shell: |
    set -ex
    skopeo copy --authfile {{ partner_creds }} --remove-signatures \
    docker://{{ operator_bundle }} \
    docker://{{ provisionhost_registry }}/telcoci/simple-demo-operator-bundle
  when:
    - dci_disconnected | default(false) | bool
    - provisionhost_registry|length
    - partner_creds|length
    - operator_bundle is defined
    - operator_bundle|length

- name: Create temporary directory
  tempfile:
    state: directory
    prefix: tnf_test_example_prerun_tmp_dir.
  register: tnf_test_example_prerun_tmp_dir

- name: Create a common catalog image for simple-demo-operator bundle to be tested in disconnected environment
  block:
    - name: Build catalog image in temporary directory
      environment:
        - REGISTRY_AUTH_FILE: "{{ partner_creds }}"
      shell: |
        opm index add --pull-tool podman \
        --bundles {{ operator_bundle }} \
        --tag {{ operator_catalog }}
      args:
        chdir: "{{ tnf_test_example_prerun_tmp_dir.path }}"

    - name: Push catalog image into local registry
      shell: |
        podman push --authfile {{ partner_creds }} {{ operator_catalog }}
      args:
        chdir: "{{ tnf_test_example_prerun_tmp_dir.path }}"
  when:
    - dci_disconnected | default(false) | bool
    - partner_creds|length
    - operator_bundle is defined
    - operator_bundle|length
    - operator_catalog is defined
    - operator_catalog|length

- name: Manage imageContentSourcePolicy update
  block:
    - name: Save catalog mirror into temporary directory
      shell: |
        {{ oc_tool_path }} adm catalog mirror -a {{ partner_creds }} \
        {{ operator_catalog }} {{ provisionhost_registry }} --to-manifests={{ tnf_test_example_prerun_tmp_dir.path }}/tmp_oc

    # It seems that we don't need to modify the ICSP created or check for updated MCPs after applying this
    - name: Apply ImageContentSourcePolicy
      k8s:
        definition: "{{ lookup('file', tnf_test_example_prerun_tmp_dir.path + '/tmp_oc/imageContentSourcePolicy.yaml') }}"
  when:
    - dci_disconnected | default(false) | bool
    - provisionhost_registry|length
    - partner_creds|length
    - operator_catalog is defined
    - operator_catalog|length

- name: Remove temporary directory
  file:
    path: "{{ tnf_test_example_prerun_tmp_dir.path }}"
    state: absent
