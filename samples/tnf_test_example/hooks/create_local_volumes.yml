- name: Create local volume
  community.kubernetes.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: PersistentVolume
      metadata:
        name: "volume-{{ volume_name_suffix }}"
        labels:
          type: local
          cnf: "{{ app_ns }}"
      spec:
        capacity:
          storage: 10Mi
        volumeMode: Filesystem
        accessModes:
        - ReadWriteOnce
        persistentVolumeReclaimPolicy: Delete
        storageClassName: local-storage
        local:
          path: /mnt/data
        nodeAffinity:
          required:
            nodeSelectorTerms:
            - matchExpressions:
              - key: nodeType
                operator: In
                values:
                - worker

- name: Wait until volume is ready
  community.kubernetes.k8s_info:
    api_version: v1
    kind: PersistentVolume
    name: "volume-{{ volume_name_suffix }}"
  register: pv_check
  until:
    - pv_check.resources is defined
    - pv_check.resources[0].status.phase == "Available"
  retries: 6
  delay: 10
