---
- name: "Install required rpm packages"
  package:
    name: "{{ item }}"
    state: present
  loop:
    - curl
    - python3-openshift
    - python3-pyyaml
  become: true

- name: "Configure the namespace variable"
  set_fact:
    app_ns: "{{ dci_openshift_app_ns|default('myns') }}"

- name: Mirror image and enable mirroring
  vars:
    basic_image: mirror.gcr.io/library/nginx:latest
  block:
    - name: "basic_example : Mirror nginx image"
      include_role:
        name: mirror_images
      vars:
        images:
          - "{{ basic_image }}"
        authfile: "{{ pullsecret_tmp_file }}"

    - name: "basic_example : Create ICSP"
      vars:
        dest_image: "{{ dci_local_registry }}/{{ '/'.join(image.split('/')[1:] }}"
      community.kubernetes.k8s:
        state: present
        definition:
          apiVersion: v1/alpha1
          kind: ImageContentSourcePolicy
          metadata:
            name: mirror-nginx
          spec:
            repositoryDigestMirrors:
              - mirrors:
                  - "{{ dest_image }}"
                source: "{{ basic_image }}"
  when:
    - dci_disconnected | default(false) | bool
    - dci_local_registry | length
