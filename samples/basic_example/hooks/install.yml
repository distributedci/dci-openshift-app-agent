---
- name: "Create Service Account for the deployment"
  community.kubernetes.k8s:
    state: present
    namespace: "{{ dci_openshift_app_ns }}"
    definition:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: webserver
    wait: true

- name: Assign anyuid scc to deployment SA
  community.kubernetes.k8s:
    state: present
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: RoleBinding
      metadata:
        name: system:openshift:scc:anyuid
        namespace: "{{ dci_openshift_app_ns }}"
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: system:openshift:scc:anyuid
      subjects:
        - kind: ServiceAccount
          name: webserver
          namespace: "{{ dci_openshift_app_ns }}"
    wait: true

- name: "Create a deployment of a webserver pod(s)"
  community.kubernetes.k8s:
    state: present
    namespace: "{{ app_ns }}"
    definition: "{{ lookup('template', 'deployment.yml.j2') }}"
    wait: true

- name: "Create a service for the webserver pod(s)"
  community.kubernetes.k8s:
    state: present
    namespace: "{{ app_ns }}"
    definition: "{{ lookup('template', 'service.yml.j2') }}"
    wait: true
...
