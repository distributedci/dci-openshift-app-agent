---

- name: Create temporary file for saving pullsecret content
  tempfile:
    state: file
    prefix: pullsecret_file.
  register: pullsecret_tmp_file

- name: Retrieve pullsecret from job_info
  set_fact:
    dci_pullsecret: "{{ job_info.job.topic.data.pull_secret | json_query('auths') | default({}) }}"
  no_log: true

- name: Read content from partner_creds variable and save it in a variable
  block:
    - name: Check if partner_creds file exists
      stat:
        path: "{{ partner_creds }}"
      register: partner_creds_exist

    - name: Fail if we cannot read partner_creds file
      fail:
        msg: "{{ partner_creds }} path is not readable"
      when: not partner_creds_exist.stat.exists|bool

    # Task will continue at this point if partner_creds is readable
    - name: Read content from partner_creds variable
      command: cat {{ partner_creds }}
      register: partner_creds_content
      no_log: true

    - name: Transform partner_creds_content in JSON
      set_fact:
        partner_pullsecret: "{{ partner_creds_content.stdout | from_json | json_query('auths') | default({}) }}"
      no_log: true
  when: partner_creds|length > 0

- name: Setting partner_pullsecret to empty JSON if partner_creds is not provided
  set_fact:
    partner_pullsecret: {}
  when: partner_creds|length == 0
  no_log: true

# If there is a secret that appears in both dci_pullsecret and partner_pullsecret,
# the one from partner_pullsecret will be taken
- name: Combine both pullsecrets
  set_fact:
    pullsecret: "{{ dci_pullsecret | combine(partner_pullsecret) }}"
  no_log: true

- name: Copy the content of pullsecret in the temp file
  copy:
    content: "{ 'auths': {{ pullsecret }} }"
    dest: "{{ pullsecret_tmp_file.path }}"

...
