---

- name: Create temporary file for saving pullsecret content
  tempfile:
    state: file
    prefix: pullsecret_file.
  register: pullsecret_tmp_file

- name: Retrieve pullsecret from job_info
  set_fact:
    pullsecret: "{{ job_info.job.topic.data.pull_secret | default({}) }}"
  no_log: true

- name: Copy the content of pullsecret in the temp file
  copy:
    content: "{{ pullsecret }}"
    dest: "{{ pullsecret_tmp_file.path }}"

# Remember that partner_creds variable must contain a value if we are on
# disconnected environments, in whose case it must contain at least local
# registry creds and optionally have private registry creds for partners.
# If it is a connected environment, partner_creds is optional, and if it
# has a value, it would just contain private registry creds for partners.
# In this task, if partner_creds does not have a value, then pullsecret_tmp_file
# will be used as unique pullsecret file in skopeo commands, used in
# disconnected environments. However, pullsecret_tmp_file does not contain
# local registry creds, so skopeo may not work properly. This problem would
# be fixed by properly defining partner_creds as explained.
- name: Build authfile references for skopeo copy commands
  set_fact:
    skopeo_copy_authfiles: "{{ ( partner_creds|length ) | ternary('--src-authfile ' + pullsecret_tmp_file.path + ' --dest-authfile ' + partner_creds, '--authfile ' + pullsecret_tmp_file.path) }}"

...
