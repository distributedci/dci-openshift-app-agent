---

- name: Create temporary file for saving pullsecret content
  tempfile:
    state: file
    prefix: pullsecret_file.
  register: pullsecret_tmp_file

- name: Retrieve pullsecret from job_info
  set_fact:
    pullsecret: "{{ job_info.job.topic.data.pull_secret | default({}) }}"
  no_log: true

- name: Copy the content of pullsecret in the temp file
  copy:
    content: "{{ pullsecret }}"
    dest: "{{ pullsecret_tmp_file.path }}"

# As partner_creds variable may be defined or not (it's optional), we will
# build here how to define authfiles to be used by skopeo copy commands
# depending on partners_creds presence or not
# If partner_creds is not defined, it is supposed that pullsecret_tmp_file
# has all the credentials required to do the copy of images
- name: Build authfile references for skopeo copy commands
  set_fact:
    skopeo_copy_authfiles: "{{ ( partner_creds|length ) | ternary('--src-authfile ' + pullsecret_tmp_file.path + ' --dest-authfile ' + partner_creds, '--authfile ' + pullsecret_tmp_file.path) }}"

...
