---

- name: pre-run
  dci_job:
    id: "{{ job_id }}"
    status: "pre-run"
  tags: [dci]

- name: Include installed software as components
  vars:
    rpms_to_components: "{{ dci_rpms_to_components }}"
    gits_to_components:
      - "{{ dci_gits_to_components }}"
      - "{{ dev_gits_to_components }}"
  include_role:
    name: include-components

 ### Mirror must-gather images

- name: "dci-openshift-app-agent : Mirror must gather images"
  include_role:
    name: mirror_images
  vars:
    images: "{{ dci_must_gather_images | default(['registry.redhat.io/openshift4/ose-must-gather']) }}"
    local_registry: "{{ provisionhost_registry }}"
    authfile: "{{ pullsecret_tmp_file }}"
  when:
    - dci_disconnected | default(false) | bool
    - provisionhost_registry|length

- name: "Get the OCP registry details"
  community.kubernetes.k8s_info:
    api: imageregistry.operator.openshift.io/v1
    kind: Config
    name: cluster
  register: registry_status

- name: "Get registry state"
  set_fact:
    registry_status: "{{ registry_status.resources[0].spec.managementState }}"

- name: "The internal registry is already configured"
  fail:
    msg: "The internal registry is already configured, refusing to configure it again"
  when:
    - registry_status == "Managed"
    - enable_ocp_registry | default(false) | bool

- name: "Enable the OCP internal Registry"
  include_tasks: plays/enable-ocp-registry.yml
  when:
    - enable_ocp_registry | default(false) | bool
    - registry_status == "Removed"
...
