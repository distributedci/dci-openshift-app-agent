---

- name: pre-run
  dci_job:
    id: "{{ job_id }}"
    status: "pre-run"
  tags: [dci]

# Prepare host
- name: "Configure DCI jumphost"
  include_tasks: configure.yml

# lookup ocp component
- name: Find the corresponding ocp component
  dci_component:
    name: "{{ ocp_version }}"
    topic_id: "{{ job_info['job']['topic_id'] }}"
    type: ocp
    state: search
  register: ocp_components
  tags: [dci]
  ignore_errors: true

- name: Attach package component to the job
  dci_job_component:
    component_id: " {{ ocp_components[0].component.id }} "
    job_id: " {{ job_id }} "
  when:
    - "ocp_components exists"
    - "ocp_components|length"
    - "'component' in ocp_components[0]"
    - "'id' in ocp_components[0].component"
  tags: [dci]

- name: Gather the package facts
  package_facts:
    manager: auto

- include_tasks: track_rpm.yml
  with_items: "{{ dci_rpms_to_components }}"

- include_tasks: track_git_repo.yml
  with_items:
    - "{{ dci_gits_to_component }}"

- name: Mirror must-gather images for offline mode
  command:
    cmd: >
      skopeo copy --remove-signatures --all --authfile {{ provisionhost_registry_creds }}
      --dest-tls-verify=false docker://{{ item }}
      docker://{{ provisionhost_registry }}/{{ item | regex_replace('^[^/]*/', '') }}
  register: skopeo_copy
  retries: 5
  delay: 5
  until:
    - skopeo_copy is not failed
  loop: "{{ dci_must_gather_images | default(['registry.redhat.io/openshift4/ose-must-gather']) }}"
  when:
    - provisionhost_registry|length
    - provisionhost_registry_creds|length

...
