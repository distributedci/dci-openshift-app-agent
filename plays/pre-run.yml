---

- name: pre-run
  dci_job:
    id: "{{ job_id }}"
    status: "pre-run"
  tags: [dci]

# Prepare host
- name: "Configure DCI jumphost"
  include_tasks: configure.yml

- name: Gather the package facts
  package_facts:
    manager: auto

- include_tasks: track_rpm.yml
  with_items: "{{ dci_rpms_to_components }}"

- include_tasks: track_git_repo.yml
  with_items:
    - "{{ dci_gits_to_component }}"

- name: Mirror must-gather images for offline mode
  command:
    cmd: >
      skopeo copy --remove-signatures --all --authfile {{ dci_pullsecret_file }}
      --dest-tls-verify=false docker://{{ item }}
      docker://{{ local_image_location }}
  vars:
    dci_pullsecret_file: "{{ tnf_registry_creds }}"
    local_registry: "{{ tnf_registry }}"
    local_image_location: "{{ local_registry }}/{{ item | regex_replace('^[^/]*/', '') }}"
  register: skopeo_copy
  retries: 5
  delay: 5
  until:
    - skopeo_copy is not failed
  loop: "{{ dci_must_gather_images | default(['registry.redhat.io/openshift4/ose-must-gather']) }}"
  when:
    - tnf_registry_creds is defined
    - tnf_registry_creds | length > 0
    - tnf_registry is defined
    - tnf_registry | length > 0

...
