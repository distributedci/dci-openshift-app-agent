---

- name: Parse claim.json
  vars:
    cnf_operators_file: "{{ lookup('file', job_logs.path + '/claim.json') | from_json }}"
  set_fact:
    cnf_operators: "{{ cnf_operators_file | json_query('claim.configurations.testTarget.operators') }}"

# pyxis_identifier field will be set to the general pyxis_identifier
# variable that is described in the pyxis role, or to '' if not
# providing that variable, but note that, if you do not define
# pyxis_identifier, preflight may fail in future releases where the
# field is mandatory.
- name: Include new operators in preflight_operators_to_certify
  vars:
    operator_bundles: "{{ preflight_operators_to_certify | map(attribute='bundle_image') | list | unique }}"
  set_fact:
    preflight_operators_to_certify: "{{ preflight_operators_to_certify +
      [ { 'bundle_image'    : item.installPlans[0].bundleImage,
          'index_image'     : item.installPlans[0].indexImage|default(''),
          'pyxis_identifier': pyxis_identifier|default('') } ]
    }}"
  when:
    - item.installPlans[0].bundleImage is defined
    - item.installPlans[0].bundleImage | length
    - not item.installPlans[0].bundleImage in operator_bundles
  loop: "{{ cnf_operators }}"

- name: Print final preflight_operators_to_certify variable
  debug:
    msg: "{{ preflight_operators_to_certify }}"
...
