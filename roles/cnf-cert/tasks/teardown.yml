---
# Only remove the local tnf image if:
# - It's not generated from the latest, stable version (test_network_function_version)
# - It has already been created (tnf_image and tnf_version_image would exist)
- name: Local tnf image removal process
  block:
    - name: Gather tnf image info
      containers.podman.podman_image_info:
        name: "{{ tnf_image }}"
      register: tnf_image_info

    - name: Try to remove the local tnf image
      block:
        - name: Retrieve current containers being executed in the jumphost
          containers.podman.podman_container_info:
          register: containers_running
          no_log: true

        - name: Activate flag variable if one of the containers is based on tnf_image
          set_fact:
            container_with_tnf: true
          with_items: "{{ containers_running.containers }}"
          when: tnf_image in item["ImageName"]
          no_log: true

        - name: Remove tnf image only if it is not being used by a container
          containers.podman.podman_image:
            name: "{{ tnf_image }}"
            state: absent
          when: not container_with_tnf|default(false)

      when: tnf_image_info.images|length
  when:
    - tnf_image is defined
    - tnf_version_image | default('') != test_network_function_version

- name: Removing PodSecurity-related labels in default namespace
  community.kubernetes.k8s:
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: default
        labels:
          pod-security.kubernetes.io/enforce: null
          pod-security.kubernetes.io/enforce-version: null
  when: ocp_version is version("4.12", ">=")
...
