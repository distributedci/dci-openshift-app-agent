---
- name: "Verify the presence of {{ t.filename }} in the log folder"
  find:
    paths: "{{ job_logs.path }}"
    patterns: '{{ t.filename }}'
  register: junit_file

- name: "Fail if {{ t.filename }} is not present in the log folder"
  fail:
    msg: "Could not verify test results: {{ t.filename }} is not present"
  failed_when:
    # there is no junit associated with the test or several ones
    - junit_file.matched == 0 or junit_file.matched > 1
    # Do not fail when the option to skip missing files is on
    - not skip_absent_testfiles | bool

- block:
    - name: "Retrieve the actual test results from {{ t.filename }}"
      vars:
        junit_filename: "{{ job_logs.path }}/{{ junit_file.files[0].path }}"
      set_fact:
        actual_results: "{{ junit_filename | junit2dict }}"

    - name: "Fail if not all test results are as expected for {{ t.filename }}"
      vars:
        expectation_failed: "{{ t.expected_results | regex_diff(actual_results) }}"
      fail:
        msg: "The following expectations failed: {{ expectation_failed }}"
      when: expectation_failed | length > 0
  when: junit_file.stat.exists
...
