---
- name: Setup tmp preflight folders
  block:
    - name: Create temporary preflight_tmp_dir directory
      tempfile:
        state: directory
        prefix: preflight_tmp_dir.
      register: preflight_tmp_dir

    - name: Set directories for artifacts and operator bundle extract
      set_fact:
        preflight_artifacts: "{{ preflight_tmp_dir.path }}/artifacts"
        preflight_kubeconfig: "{{ preflight_tmp_dir.path }}/kubeconfig"

    - name: Create directories to mount artifacts volume and kubeconfig volume
      file:
        path: "{{ preflight_dir_to_create }}"
        state: directory
        mode: 0744
      loop:
        - "{{ preflight_artifacts }}"
        - "{{ preflight_kubeconfig }}"
      loop_control:
        loop_var: preflight_dir_to_create

    - name: Copy kubeconfig file into kubeconfig folder
      copy:
        src: "{{ kubeconfig_path }}"
        dest: "{{ preflight_kubeconfig }}"

- name: Set operator index image by default
  set_fact:
    OO_INDEX: "{{ operator.index_image }}"

- name: Manage operator in the disconnected environment
  include_tasks: disconnected_env.yml
  when: dci_disconnected | default(false) | bool

- name: Create preflight namespace
  k8s:
    name: "{{ preflight_namespace }}"
    api_version: v1
    kind: Namespace
    state: present

- name: Run preflight check operator tests
  environment:
    - OPENSHIFT_AUTH: "{{ all_registries_creds }}"
    - OO_BUNDLE: "{{ operator.image }}"
    - OO_INDEX: "{{ OO_INDEX }}"
  shell: >
    podman run
    -it
    --rm
    --pull=always
    --privileged
    -e PFLT_JUNIT=true
    -e PFLT_ARTIFACTS=/artifacts
    -e PFLT_LOGFILE=/artifacts/preflight.log
    -e PFLT_LOGLEVEL=trace
    -e KUBECONFIG=/kubeconfig
    -e PFLT_INDEXIMAGE={{ OO_INDEX }}
    -e PFLT_NAMESPACE={{ preflight_namespace }}
    -e PFLT_SERVICEACCOUNT=default
    -e PFLT_SCORECARD_IMAGE={{ config_images[0] }}
    -v {{ preflight_kubeconfig }}/kubeconfig:/kubeconfig
    -v {{ preflight_artifacts }}:/artifacts
    {{ preflight_version }}
    check operator
    {{ operator.image }}
  async: 350
  poll: 0
  register: preflight_exec

- name: Retrieve simple-demo-operator logs
  block:
    - name: Wait 160 seconds
      pause:
        seconds: 160

    - name: Get events for simple-demo-operator namespace
      shell: |
        {{ oc_tool_path }} get events --namespace simple-demo-operator
      ignore_errors: true

    - name: Get events for simple-demo-operator-target namespace
      shell: |
        {{ oc_tool_path }} get events --namespace simple-demo-operator-target
      ignore_errors: true

    - name: Get subscription for simple-demo-operator
      shell: |
        {{ oc_tool_path }} get subs --namespace simple-demo-operator
      ignore_errors: true

    - name: Describe subscription for simple-demo-operator
      shell: |
        {{ oc_tool_path }} describe sub simple-demo-operator.v0.0.3 --namespace simple-demo-operator
      ignore_errors: true

    - name: Get csv for simple-demo-operator
      shell: |
        {{ oc_tool_path }} get csv --namespace simple-demo-operator
      ignore_errors: true

    - name: Describe csv for simple-demo-operator
      shell: |
        {{ oc_tool_path }} describe csv simple-demo-operator.v0.0.3 --namespace simple-demo-operator
      ignore_errors: true

    - name: Get preflight pods
      shell: |
        {{ oc_tool_path }} get pods --namespace simple-demo-operator
      ignore_errors: true

    - name: Get pod images
      shell: |
        {{ oc_tool_path }} get pods --namespace simple-demo-operator -o jsonpath="{.items[*].spec.containers[*].image}"
      ignore_errors: true

    - name: Retrieve preflight pods in a short form
      shell: |
        {{ oc_tool_path }} get pods --namespace simple-demo-operator -o custom-columns=POD:.metadata.name --no-headers
      register: preflight_pods
      ignore_errors: true

    - name: Retrieve logs
      shell: |
        {{ oc_tool_path }} logs pod/{{ pod_name }} --namespace simple-demo-operator
      loop: "{{ preflight_pods.stdout.split('\n') }}"
      loop_control:
        loop_var: pod_name
      ignore_errors: true

    - name: Describe all pods
      shell: |
        {{ oc_tool_path }} describe pod/{{ pod_name }} --namespace simple-demo-operator
      loop: "{{ preflight_pods.stdout.split('\n') }}"
      loop_control:
        loop_var: pod_name
      ignore_errors: true

- name: Check on preflight execution
  async_status:
    jid: "{{ preflight_exec.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  retries: 7
  delay: 50
  ignore_errors: true

- name: Delete preflight namespace
  k8s:
    name: "{{ preflight_namespace }}"
    api_version: v1
    kind: Namespace
    state: absent

- name: Upload logs for preflight check operator into DCI
  vars:
    preflight_prefix: "preflight_{{ operator.name }}_{{ operator.version }}"
  copy:
    src: "{{ item }}"
    dest: "{{ job_logs.path }}/{{ preflight_prefix }}_{{ item | basename }}"
  with_fileglob:
    - "{{ preflight_artifacts }}/*"

- name: Remove tmp dir
  file:
    path: "{{ preflight_tmp_dir.path }}"
    state: absent
...
